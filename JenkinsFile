pipeline {
  agent any
  environment {
    IMAGE_NAME   = "purnachandrared/simplelife-app"
    TAG          = "${env.BUILD_NUMBER}"
    // Ensure Jenkins sees brew-installed docker; safe to append
    PATH         = "${env.PATH}:/opt/homebrew/bin:/usr/local/bin"
    // Keep Docker creds local to this workspace; avoids osxkeychain helper
    DOCKER_CONFIG = "${env.WORKSPACE}/.docker"
  }
  stages {
    stage('Checkout') {
      steps { checkout scm }
    }

    stage('Build') {
      steps {
        sh '''
          docker --version
          docker system prune -f || true
          docker build -t ${IMAGE_NAME}:${TAG} -t ${IMAGE_NAME}:latest .
        '''
      }
    }

    stage('Login & Push') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'docker-cred', usernameVariable: 'U', passwordVariable: 'P')]) {
          sh '''
            mkdir -p "$DOCKER_CONFIG"
            echo "$P" | docker login -u "$U" --password-stdin
            docker push ${IMAGE_NAME}:${TAG}
            docker push ${IMAGE_NAME}:latest
          '''
        }
      }
    }
  }
  post {
    always {
      // logout + remove temp auth so no keychain helper is needed
      sh 'docker logout || true'
      sh 'rm -rf "$DOCKER_CONFIG" || true'
    }
  }
}